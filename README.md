<h1>Static Malware Analysis</h1>

<h2>Description</h2>
This project involves performing some static malware analysis on some known malware samples. This is performed within our malware analysis lab created in a Windows 10 virtual machine running VMware.
<br />


<h2>Languages and Utilities Used</h2>

- <b>VMware</b> 
- <b>Hashcalc</b> 
- <b>VirusTotal</b>
- <b>VMware</b> 
- <b>Exeinfo PE</b>
- <b>HxD</b>
- <b>PEStudio</b>
- <b>Cmder</b>
  - <b>XORSearch</b>
  - <b>FLOSS</b>



<h2>Environments Used </h2>

- <b>Windows 10</b>

<h2>Program walk-through:</h2>

<p align="center">
First we will load our malware sample into the HxD utility. HxD will display the file's content in hexadecimal format on the left side and the corresponding ASCII characters on the right side. The hexadecimal view shows the raw data, while the ASCII view can give hints about readable strings and potential indicators of malicious behavior. We can use the search feature (or Ctrl+F) to search for specific strings within the file, for example, the first two bytes 4D 5A indicate an MZ header, common in Windows executables.<br/>
<br/>
<img src="https://i.imgur.com/pTdzjAM.png" height="80%" width="80%" alt="Searching for specific strings"/>
<br/>
<br/>
Here we see exactly the 4D and 5A bytes, which warrants taking a closer look at the sameple. Next we will search for the message "This program cannot be run in DOS mode" within the ASCII characters on the right. When analyzing a file in a hex editor like HxD, encountering this message in the initial bytes of the file is a strong indicator that the file is a Windows PE executable and helps confirm the file format before delving into more detailed analysis.<br/>
<br/>
<br/>
<img src="https://i.imgur.com/CvkKarY.png" height="80%" width="80%" alt="Searching for malware inidcators"/>
<br/>
<br/>
Using this program is particularly useful because even if the file has been given the wrong extension, for example a .jpg extension, the hex editor will still be able to identify the true contents of the file and display it to us.<br/>
<br/>
<br/>
Another useful tool for this is the Cmder utility. If we open this, type *file* and then drag in the file (or type the file path), this utility will tell us the format of the file, regardless of the extension that it has been given.<br/>
<br/>
<img src="https://i.imgur.com/FhSrLv4.png" height="80%" width="80%" alt="Using Cmder to analyze file type"/>
<br/>
<br/>
Now that we've confirmed the file type, we can go ahead and fingerprint the file using a hashing utility, in this case HashCalc.<br/>
<br/>
<br/>
<img src="https://i.imgur.com/viGI0Eq.png" height="80%" width="80%" alt="Take hash fingerprint of file"/>
<br />
<br />
Then we can use a database of known malicious files to cross reference it. For this we will use virustotal.com.<br/>
<br/>
<br/>
<img src="https://i.imgur.com/McPgR4E.png" height="80%" width="80%" alt="Upload to virustotal"/>
<br/>
<br/>
VirusTotal will tell us whether the file had been previously identified as malicious by multiple antivirus engines, providing insights into its threat level and history.<br/>
<br/>
<img src="https://i.imgur.com/b6dL3xJ.png" height="80%" width="80%" alt="Virustotal results"/>
<br/>
<br/>
Now we can move on to searching for strings within the malware that can give us further insight into the nature of the malware. To do this we go back to the Cmder utility and input the command "strings -n 5 C: \Users \SOC \Desktop \Malware \XMoon. exe". This searches for all strings above five characters and can help narrow down the search. We can input any number within this command to narrow down our search.<br/>
<br/>
<br/>
<img src="https://i.imgur.com/A51YGjE.png" height="80%" width="80%" alt="Search for strings with Cmder"/>
<br/>
<br/>
Already we see some suspicious contents.
<br/>
<br/>
<img src="https://i.imgur.com/oa6WINJ.png" height="80%" width="80%" alt="Suspicious contents"/>
<br/>
<br/>
<img src="https://i.imgur.com/Z10XAms.png" height="80%" width="80%" alt="More suspicious contents"/>
<br/>
<br/>
We can also output these strings to a .txt file for forensic purposes and to facilitate searching through the contents.<br/>
<br/>
<br/>
<img src="https://i.imgur.com/AFXvYlh.png" height="80%" width="80%" alt="Output strings to txt file"/>
<br/>
<br/>
<img src="https://i.imgur.com/rP3rMAc.png" height="80%" width="80%" alt="Strings within txt file"/>
<br/>
<br/>
Another tool for extracting and searching through strings in the Bintext utility. The benefit of Bintext is that it has a graphical interface and can be more accessible to users who prefer GUI over CLI.<br/>
<br/>
<br/>
<img src="https://i.imgur.com/blRrhKk.png" height="80%" width="80%" alt="Strings in Bintext"/>
<br/>
<br/>
The next tool we can use within Cmder is XORSearch. XORSearch is a utility specifically designed for searching XOR-encoded data within binary files. XOR (exclusive OR) encoding is a common technique used by malware authors to obfuscate strings and data within their programs. XORSearch helps analysts find such obfuscated data by performing searches with various XOR keys. Using XORSearch we can search for specific patterns or strings within the encoded data such as URLs.
<br/>
<br/>
<img src="https://i.imgur.com/LDlFmA9.png" height="80%" width="80%" alt="Using XORSearch"/>
<br/>
<br/>
Attackers often obfuscate strings to hide command-and-control (C2) server addresses, file paths, and other critical information. FLOSS (FireEye Labs Obfuscated String Solver) is a tool designed to automatically detect and deobfuscate strings hidden within binary files. This tool is particularly useful in malware analysis. Using FLOSS within a terminal like Cmder allows for efficient analysis of such obfuscated strings. If we type "floss" before our file path in Cmder, FLOSS will output the deobfuscated strings, allowing you to identify potential indicators of compromise (IOCs) such as URLs, IP addresses, file paths, and other critical information.
<br/>
<br/>
<img src="https://i.imgur.com/dwmqAi1.png" height="80%" width="80%" alt="Using floss"/>
<br/>
<br/>
<img src="https://i.imgur.com/P6Xe86x.png" height="80%" width="80%" alt="Floss findings"/>
<br/>
<br/>
In this case we've uncovered some strings that provide valuable clues to us. Let's break these down:<br/>
<br/>
</p>
- <br>.dla: This could be a file extension or a custom identifier used by the malware. Further investigation may be needed to determine its relevance.<br/>
- <br>VS_VERSION_INFO: Indicates version information about the software. This is often found in legitimate software and can provide clues about the malware's origins or how it tries to disguise itself as legitimate software.<br/>
- <br>StringFileInfo: Part of the version information structure, typically includes details like the file description, version, and other metadata.<br/>
- <br>FileDescription: This is a description of the file, which can sometimes reveal what the malware purports to be or its intended functionality.<br/>
- <br>FileVersion: Indicates the version of the malware. This can be useful in identifying different variants of the same malware family.<br/>
- <br>CompiledScript: Suggests that the malware may be a compiled script. This could indicate the use of scripting languages like AutoIt or others.<br/>
- <br>AutoIt v3 Script: This is particularly notable. AutoIt is a scripting language often used to create automation scripts in Windows. Malware authors sometimes use AutoIt to develop their payloads, as it can be easily obfuscated and packed.<br/>
- <br>VarFileInfo and Translation: These are also part of the version information structure and may provide additional metadata about the file.<br/>
-
<br/>
<br/>
Another technique often employed by malware authors to evade detection by antivirus software and to make analysis more difficult for security researchers is <b>packing</b>. Packing is used to compress or encrypt an executable file to hide its true content and behavior. Packed malware can evade signature-based detection because the packed version differs significantly from the original, known malware sample.

Ton combat this, we can use Exeinfo PE to identify if a file is packed and which packer was used.
<br/>
<br/>
<img src="https://i.imgur.com/HqMQQOn.png" height="80%" width="80%" alt="Malware in ExeinfoPE"/>
<br/>
<br/>
Recognizing if a file is packed can inform analysts that they need to unpack the file to analyze its true behavior and knowing the specific packer used can guide the choice of unpacking tools or techniques. In this case we see the packer used was UPX, UPX stands for "Ultimate Packer for eXecutables" and is a popular and widely used executable packer.

Now we have this information we can go back to Cmder and use UPX to unpack the malware. To do this we navigate to the directory containing the malware and then input "upx -d -o" [Insert unpacked file name] [Insert malware file name]. The -d stands for "decompress" and the -o instructs Cmder to output the unpacked file.<br/>
<br/>
<img src="https://i.imgur.com/bXYBMYL.png" height="80%" width="80%" alt="Instruct Cmder to unpack malware file"/>
<br/>
<br/>
Now if we take a look at the unpacked file we can see a key difference in the size of the original malware file and the unpacked output. The difference in size indicates that the file was obfuscated through compression. This is a common technique used by malware authors to evade detection and analysis.
<br/>
<br/>
<img src="https://i.imgur.com/ZwzwqT3.png" height="80%" width="80%" alt="Observed differences in file sizes"/>
<br/>
<br/>
One more very powerful tool we have in our malware analysis arsenal is PEStudio. 
<img src="https://i.imgur.com/ZwzwqT3.png" height="80%" width="80%" alt="Insert desc"/>
<br/>
<br/>



<p>
Observe the wiped disk:  <br/>
<img src="https://i.imgur.com/dwmqAi1.png" height="80%" width="80%" alt="Disk Sanitization Steps"/>
</p>

<!--
 ```diff
- text in red
+ text in green
! text in orange
# text in gray
@@ text in purple (and bold)@@
```
--!>
